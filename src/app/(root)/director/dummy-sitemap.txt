import { BASE_URL_FRONTEND } from '@/constants';
import { formatToUrl } from '@/lib/formatters';
import {
  getDirectorSitemaps,
  getTotalDirectorCount,
} from '@/services/sitemapHelperFunction';
import { MetadataRoute } from 'next';

export const revalidate = 86400; // cache for 1 day = 60 * 60 * 24

export async function generateSitemaps() {
  const count = await getTotalDirectorCount();
  const sitemapsNeeded = Math.ceil(count / 8000);
  const sitemaps = [];

  for (let i = 0; i < sitemapsNeeded; i++) {
    sitemaps.push({ id: i });
  }

  return sitemaps;
}

export default async function sitemap({
  id,
}: {
  id: number;
}): Promise<MetadataRoute.Sitemap> {
  // Google's limit is 50,000 URLs per sitemap
  const start = id * 8000;
  const end = start + 8000;

  const companies = await getDirectorSitemaps(start, end);

  // Use flatMap to return a flattened array of sitemap URLs
  const sitemapUrls = companies.flatMap((director: any) => {
    const directorUrl = `${BASE_URL_FRONTEND}/director/${formatToUrl(
      director.fullName
    )}/${director.din}`;

    const urls = [
      {
        url: directorUrl,
        lastModified: new Date().toISOString(),
        priority: 1,
        changeFrequency: 'weekly',
      },
    ];

    return urls;
  });

  return sitemapUrls;
}
